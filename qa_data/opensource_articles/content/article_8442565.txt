Категория: Битрикс24

ТЕМА: Настройка сервера и модуля портала для Открытых линий в Битрикс24 "в коробке"

ПРОБЛЕМА:
Для корректной работы Открытых линий в Битрикс24 "в коробке" требуются специфические настройки сервера и модуля портала, которые часто вызывают затруднения у администраторов.

РЕШЕНИЕ:
1.  Общие серверные настройки:
1.    *   Убедиться в доступности адреса `https://адрес_портала/pub/imconnector/` извне.
2.    *   Проверить наличие действующего лицензионного ключа.
3.    *   Обеспечить доступ сервера ко всем внешним адресам сервисов коннекторов (Viber, VK и т.п.) по HTTP/HTTPS.
4.    *   При использовании Nginx, установить `nginx proxy_ignore_client_abort on` для нужного `location`.
5.    *   При использовании php-fpm, установить `fastcgi_ignore_client_abort on`.
6.    *   Для коннектора "Онлайн-чат" разрешить `X-Frame-Options SAMEORIGIN` для `location /online/(/?)([^/]*)`, если это не блокируется в "Проактивной защите".
7.    *   Для коннектора "Битрикс24.Нетворк":
8.        *   Установить и настроить модуль "Чат-боты Битрикс24".
9.        *   Обеспечить доступ без авторизации к `/pub/imbot.php`.
10.        *   При проблемах с сообщениями, включить "Долгое ожидания ответа" в настройках модуля "Чат-боты Битрикс24".
11.    *   Возможно, потребуется отключить редиректы для файлов коннекторов вроде `~/index.php` на `/`.

2.  Настройка модуля "Коннекторы для внешних мессенджеров":
1.    *   Проверить корректность указания "Публичного адреса сайта" (адрес портала с протоколом).
2.    *   При необходимости отладки, включить "Режим отладки" для записи ошибок в `/bitrix/modules/imconnector_error.log`.
3.    *   Выбрать необходимые коннекторы в списке "Список используемых коннекторов".

3.  Настройка модуля "Открытые линии":
1.    *   При необходимости отладки, включить "Режим отладки" для записи ошибок в `/bitrix/modules/imopenlines.log`.

ВАЖНО:
1.   Все настройки должны выполняться Администратором системы.
2.   Для работы Открытых линий на каждого внешнего клиента создается пользователь типа экстранет.
3.   Основная причина ошибок подключения каналов - неверно указанный или недоступный из интернета публичный адрес портала.

ТЕХНИЧЕСКИЕ ДЕТАЛИ:
1.   Файлы логов ошибок:
2.    *   `bitrix/modules/imconnector_error.log` (для коннекторов)
3.    *   `bitrix/modules/imopenlines.log` (для Открытых линий)
4.   Параметры Nginx: `proxy_ignore_client_abort on`
5.   Параметры FastCGI: `fastcgi_ignore_client_abort on`
6.   HTTP-заголовок: `X-Frame-Options SAMEORIGIN`

СВЯЗАННЫЕ ВОПРОСЫ:
1.   Как правильно указать публичный адрес сайта в настройках коннекторов?
2.   Какие настройки сервера необходимы для стабильной работы Открытых линий?
3.   В чем разница между логом ошибок и логом трассировки сообщений?
4.   Как проверить доступность адреса `pub/imconnector/` извне?